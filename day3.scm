
(define not
  (lambda (x)
    (if x
        0
        1)))

(define land
  (lambda (a b)
    (if a b 0)))

(define len
  (lambda (l)
    (define len-inner
      (lambda (l so-far)
        (if (null? l)
            so-far
            (len-inner (cdr l) (+ so-far 1)))))
    (len-inner l 0)))

(define foreach
  (lambda (l c)
    (if (not (null? l))
        (let ()
          (c (car l))
          (foreach (cdr l) c)))))

(define digit-char?
  (lambda (c)
    (land (<= 48 c) (<= c 57))))

(define char-as-digit
  (lambda (c)
    (- c 48)))

(define parse-int
  (lambda (chrs)
    (define parse-int-inner
      (lambda (chrs so-far)
        (if (null? chrs)
            null
            (if (digit-char? (car chrs))
                (parse-int-inner (cdr chrs) (+ (* so-far 10) (char-as-digit (car chrs))))
                (cons so-far chrs)))))
    (parse-int-inner chrs 0)))

(define take-until
  (lambda (c chrs)
    (if (null? chrs)
        null
        (if (eq? (car chrs) c)
            (cdr chrs)
            (take-until c (cdr chrs))))))

(define reverse
  (lambda (l)
    (define reverse-inner
      (lambda (l lo)
        (if (null? l)
            lo
            (reverse-inner (cdr l) (cons (car l) lo)))))
    (reverse-inner l null)))

(define split-on
  (lambda (chrs c)
    (define split-on-inner
      (lambda (chrs current so-far)
        (if (null? chrs)
            (reverse (cons (reverse current) so-far))
            (if (eq? (car chrs) c)
                (split-on-inner (cdr chrs) null (cons (reverse current) so-far))
                (split-on-inner (cdr chrs) (cons (car chrs) current) so-far)))))
    (split-on-inner chrs null null)))

(define idx
  (lambda (lst i)
    (if (null? lst)
        null
        (if (eq? i 0)
            (car lst)
            (idx (cdr lst) (- i 1))))))

(define char-of (lambda (s) (car (string-chars s))))

(define idx-modulo (lambda (l i m) (idx l (% i m))))

(define coord-stepper
  (lambda (x-step y-step)
    (define x 0)
    (define y 0)
    (lambda ()
      (set! x (+ x x-step))
      (set! y (+ y y-step))
      (cons x y))))

(define while
  (lambda (cnd cb)
    (if (cnd)
        (let ()
          (cb)
          (while cnd cb)))))

(define calculate-for
  (lambda (x-step y-step input)
    (define lines (split-on (string-chars input) 10))
    (define line-len (len (car lines)))
    (define x 0)
    (define y 0)
    (define stepper (coord-stepper x-step y-step))
    (define y-max (len lines))
    (define check (lambda ()
                    (< y y-max)))
    (define so-far 0)
    (while check
      (lambda ()
        (define xy (stepper))
        (set! x (car xy))
        (set! y (cdr xy))
        (define current-line (idx lines y))
        (if (len current-line)
            (let ()
              (set! so-far (+ so-far (eq? (idx-modulo current-line x line-len)
                                          (char-of "#"))))))))
    so-far))

(define day3-part1
  (lambda (input) (calculate-for 3 1 input)))

(define day3-part2
  (lambda (input)
    (define r1d1 (calculate-for 1 1 input))
    (define r3d1 (calculate-for 3 1 input))
    (define r5d1 (calculate-for 5 1 input))
    (define r7d1 (calculate-for 7 1 input))
    (define r1d2 (calculate-for 1 2 input))
    (* r1d1 (* r3d1 (* r5d1 (* r7d1 r1d2))))))

(define example-input
"..##.......
#...#...#..
.#....#..#.
..#.#...#.#
.#...##..#.
..#.##.....
.#.#.#....#
.#........#
#.##...#...
#...##....#
.#..#...#.#")

(define input
".##.....#....#....#..#.#...#.##
.###........#.##....#......#..#
#..#..#.....#...#....#.#.......
.........#.................#...
..#.......#.#.......#.......#.#
.####........#.#..##.........#.
........#.........#.........#..
#..##...##....#.....##......#..
.........#..............#......
#.........#...##.........#.#...
..............#........##.....#
##....#...........#....#.#...#.
.....#..#.....#...#.#..........
#.......#...#..##........##..#.
.#........#.......#............
.......##.....#.#.#..#.#.......
..#......#..#....##......#.#...
.....##....#..#.....#..#.......
.............#.......#.#....#..
.................#.#......#....
.#..#....#..........#.....#.##.
#.#.#.#.....###.......#.....#..
#...#..........#..#............
...#...##.......#.##..#........
..#...#.#.##...##.........#.#.#
.....#...#.#....#.#.....#......
...#...#.#..#...#.....#........
...........###.#.......#.#.....
..#..#.#........#.#.......#.#.#
.#.......#...........#.........
.#..#...##....#.......###..##..
#....#.....#....##..#.........#
#..#.......#...#......#.#....#.
......##..#..#....#.#........##
#.....#.........#......#..##..#
.#..#.......#....#............#
....#..........#.#...##....#.##
..#...#.#...#.###.#..#......#..
#.#...#..............#.......#.
..##.......#......#....###.....
......#.......#.#.##.#..##.#...
.#......#......#.#....#..#.#..#
....#....#..#...#.....#.#..#...
.#.....#.#.#..#........#.#.###.
#..#..#.#......#..#..#....#.#..
..#.###....#....##...#.........
...........#..#...........#....
.................#..........#.#
.#.#....#..#........#..#.......
...........##..#...............
...#.##.........#.........#.#.#
........#..#....#.#............
...##...##..................#.#
...#..##..#...#......#.....#..#
.##.#..#..#......#......#.....#
....#.....#....#......##.#.....
.....#.##....#...#.............
......#...#.....##....#...#..##
...#............#.###....##....
............#.#.#...#.#........
#.....#..#.#..##...........#.##
.....#.#.#.#..##......##.#..#..
.#.##..#.........#......#.....#
.#.#.#.#.#..#..#........###....
......##..........#.#.....##..#
..#...#..#.....#.#.....#.......
............#....#.............
........#...#..#....#.#..###...
#........##....##..............
.........#.#.#..#..#...#.#.....
....#............#....####...#.
##.#.#......#.....#...#....###.
...#..#..#..#.......#..#.#.#..#
..#..#....#...#.##..#.........#
#..#.#....#....#...#..##..#.#..
...#....#.............#..#.#..#
..#......#.##...#..............
#....##.#.#...##......#.....##.
.#...##...#...####.....##......
...........#.###....#...#...#..
##..#..##..#..#.#.#..###.......
.#...##......#........##..#....
.#...#...#.....#............#..
.#.#.#...#.#..#.......#......#.
.................#..#.#......#.
#..#####......##.#....#...#....
........#......#.....##......#.
....#.#...#...#..#.......#####.
.....##......#...#.......#....#
.#....#...#..#...#.#...#..#...#
....##.........#.#...####.#....
...##..........#.#.......##....
.........#......#.....#....#...
#....##..#......#.....##....#..
...#.#.............#...#.....#.
...........#...#.#....#..#.#...
.......#.#.#.....#..#........#.
..##.....#..#.....##..#........
...#.#..........#...#....#.#...
..#....#......#...#.#...##..#.#
.#...#..#..#..#.......#........
.................#.#...........
...............#......##.....#.
..##.....###..#....#.........##
....#.#........#.####.#...#....
.....#.....##..####..##.......#
.....####.#...#......#.........
........#..#......#.....##.....
...###..#.#..###.......#.......
...#...##..#..#..#..#.##.......
..#......##..#.....##..##......
#.......#.#..#.................
#.......#...#..###....#.#.#.#..
#...#.#....##.##.#...........#.
.#.........#..###..#.........#.
#...#......#...#.#.........#...
.#.##..............#.#....#...#
........#.....#..#.#.#......#..
............####.#......#......
......#.#.#...#.#...#.#.....#..
....#....#...#.....#.......#.#.
..#....#....###..#....#.....##.
.................#.....#.#....#
.#.............#......#.##..#..
#.....##.......#..#.....#....#.
#.#......####...##.....#....##.
.....#.#....#..................
....#....#..#.#...........##...
...#.............##......#..#..
......#..........#...#...##.###
...##......##.....#......#....#
........#.#.#...#...#..##......
......................###....##
.#.....#..#..#.##.#.#.#....#.##
.#..............#.....#......#.
.#...#.##....#.....#.#.#..#..#.
##...##.......#.....#..###.....
...#..#.#....#........#........
....#..............##...#......
...........#..#.....##.#.#.#...
#.#.....##..##.#.#........#....
.........#....#.....#..##.#...#
...#...#..#..#.####...#.......#
.....##.....##.....#......#....
#.##...#....#............#..##.
.#.##..#...#....#.#......#.....
..###................#.........
.#..#..#................#......
....#..#........#..#....#......
.#..........###......#...###...
...........##...#.#..#.........
...#....#..........#.....#..##.
..#..#.............#......###..
#....#....##.....#....#.##.....
......#.......#..#..........##.
#..##.#...#.#.........#....#.#.
...#...#..........#...#..#....#
...###..#.#......#.##.#####...#
..#.....#.#..............#..##.
#..###......#.#..#........#....
.#.......#.......#.....#.##....
.#...##..#.......##.....#....##
..........#.#..#.....#.........
.......####...#...#.....##.....
......#.......#.......#..#.#...
...##....##.#.......#.##......#
.#...#............#......##....
#..#..#...#.#........#.........
.......#.......#.....##.#......
.#....##...#....#.........#...#
#.#....#.....##...........#..#.
.....#......#....#......#.#...#
.#............#...#.#....#....#
........##..#..##..##.##....#..
........................#.#....
#....#...#.....................
##.#.............#.....#...##.#
....##....###.......#..........
..#.#..#.#...####.....#.....#..
#.........#.......#......#..##.
.#.#.............#..#...#...#..
#..#....#....#..##.........#...
#.#.....#.##.#...#.##..#.#..##.
......#......#.###....#..###...
.##...#.......#.........#.#...#
..........#...#....#..#....#...
.....#...#.....#....##....#.#..
#....#...........#.#...#.......
.###..#........##..........#...
....###.##..#...#.#..##......##
.#...#...........#...........#.
#......#....#.##.........##..#.
.#.......#........#......#.#.#.
.......#..##.........#......#..
.#..#.....##....##....#.....#..
#.#.#.....#...#......#.........
..............#.#.........#.#..
....#...#.............#.#......
..##.#............#.#.##....#..
.....####..........#.#....##..#
......#.#.........#.......###..
#....##.#...#.#...........#...#
.....#...#......#....###...#..#
#....#..............#...#......
...#..###...#..........#....#..
#......#..#.#.#......#..#...#..
................##......#..#...
....#..#..#........##..#...#...
...##.......#.##.#.....##...#.#
.......#.##.#..#.....#...#.....
......#........#..#......##.##.
....................#.....#.#..
.##....#...#...##...#.........#
..#...#..#.##..#.#.#......#....
#....###.#..#..#...#..#...##...
#.......#.....#.#.......###.#.#
.#.##...##..#......#....#...#..
#.....#.......##..#....#.......
...###...#............#....#..#
.#....#.#...#..#..#.##.#.#.#...
#......#.#..#.#.#......#.......
..#..#....###.#........#..#.#..
.......#......##.........#.....
...#...###..#..#.##.#..##......
.#.......##.......#..#..#.###.#
.###.#..#.###...........#......
...#................#.#...##..#
....#.###....#.......#........#
.##...#...#..#.....#...#.......
.#...#..#...........#.#......##
...##..#.#.#..#.#.#.......#....
.#.#..#..#.#...........#.......
..#....#.#.#.#.#..............#
..##..............##....#.#..#.
..#....#...##.....###.....#.#.#
#....#......#..........##......
.##.#.#......#...##..###..#....
.#...........#.##.......##..##.
###.....##...#.##..#...........
...#.....#...........#..#.....#
#.........#....#.......#.......
.#.#...#.###....#..#...........
.....#.......#.....#.##.#.#.#..
..##.#.........##.........#..#.
.......#....#......#.........##
...##.....#..#.......#..#.#....
..#...###.......#..#....###....
.......#...###......#.#.....#.#
#....#...#.#....#.#..........#.
........#..#.....#.#.#.........
......##.......###.......#...#.
.........#..#..#.......#.......
#.......#...#.....#.#..#....#..
.##....#..###.............#....
#.#...#.......#.....##.#.#....#
....#....##.#........##........
...##...#.#.............#...##.
##....#.....#..#..#......#.....
#...#.#........##....##......##
..#...........#..#......###....
..##..#.....#......#....##.....
....###.#...#......##......#...
....#....###...........###.#..#
..#....#...#.##....#...#.......
....##...........#............#
..#.#......#......#.##.#...#..#
#.###.............#.#.##.#.....
#....##....#..#.#.#...........#
...#...................#.......
.#...#......#.......#.#....#..#
....#...#..#..#..#.#.....#....#
..#....#............#..###..##.
...##...#...........#..#..#.#..
..#..#..#.........#.........#.#
...#.#.....#.#..##.........#...
....#..........................
....#.....#.#...#.###.........#
....#.#.......#..#.#.#...#...#.
.....#...#..#.....##....#.#.#..
#....###......#..#..........#..
.#.....#......##.......#...#.##
...#..#.....#.#.....#.......##.
............#..#....#...#..#.#.
..........#.#..#..##...........
.......#.......#..##...##.....#
....#...##.#..#...#.#.......#..
....#.#........#...####...#....
#.#.............#.............#
.#.#......#....#..#..#.....##.#
#..#...........#........#.....#
#....#....#.#..#.#....#.#...##.
....##...##...#...#...........#
...#.#..#....#..#..#..#........
...#..##..#........#..........#
#......#.##..##.......#..#.....
..#...#......#...##.#..........
.###.#..#..#........####...#...
#..............#.#.#........#..
..##....#.......#....##...#..##
.##...#..#.#.....#..#.......##.
..#.........##.......#....#..#.
.#..#...#..##.#..#.....#.......
.#....#.........#..#...#...##..
..###..######..#.##.#....#.....
....#..#.....#.............#..#
...#....#.......#..#.#.......##
.....#......#.......#..##...#..
.##..#....##..##......#...#..#.
......#......#...#...###.......
....#.....#.###..##.....#.#.##.
.......#....#...#..#..#...#.#..
...####.#...#...#.#...##....#..
......#.#....#....#.#....##....
#..##...........####....##.#...
...#...##.#.......#.#..........
..#......#..#..#...#......#....
..###..#.....#..#.#.......#...#
#........#...##..#...#....#....
...#.#...#.....#........#...#..
...#....#.###...#..#...#..##.#.
.....#..#..#...#...#..#........
..#......##...............#.#.#
.#...###.#....##..........#.#..")

(display "example")
(display (day3-part1 example-input))
(display (day3-part2 example-input))

(display "mine")
(display (day3-part1 input))
(display (day3-part2 input))
